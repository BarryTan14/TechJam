# Cultural Sensitivity Storage Implementation

## Overview
This document summarizes the implementation of cultural sensitivity analysis storage in MongoDB, ensuring that both executive reports and cultural sensitivity analysis are persisted when generated by the LangGraph workflow.

## Problem Statement
The user requested: "Ensure the cultural level is being pushed to mongodb for now"

This required:
1. Adding a new MongoDB collection for cultural sensitivity analysis
2. Updating the `ExecutiveReportManager` to handle both executive reports and cultural sensitivity analysis
3. Modifying the workflow to store both types of data using a unified method
4. Ensuring data integrity and proper retrieval capabilities

## Solution Implementation

### 1. MongoDB Configuration Updates

**File**: `mongodb_config.py`
- Added `CULTURAL_SENSITIVITY_COLLECTION = "cultural_sensitivity"` to define the new collection

### 2. ExecutiveReportManager Enhancement

**File**: `langgraph/agents/executive_report_manager.py`
- **Updated class docstring**: Now reflects management of both executive reports and cultural sensitivity analysis
- **Enhanced initialization**: Initializes both `executive_reports_collection` and `cultural_sensitivity_collection`
- **New method**: `store_cultural_sensitivity_analysis()` - Stores cultural sensitivity analysis documents
- **New method**: `store_workflow_results()` - Unified method to store both executive reports and cultural sensitivity analysis
- **Enhanced retrieval methods**: Added methods for retrieving cultural sensitivity analysis by various criteria
- **Search functionality**: Added search capabilities for cultural sensitivity analysis
- **CRUD operations**: Complete set of create, read, update, delete operations for both data types

### 3. Workflow Integration

**File**: `langgraph/langgraph_workflow.py`
- **Updated storage call**: Changed from `store_executive_report()` to `store_workflow_results()`
- **Unified storage**: Now stores both executive report and cultural sensitivity analysis in a single call
- **Enhanced logging**: Updated log messages to reflect storage of workflow results rather than just executive reports

### 4. Data Structure

#### Cultural Sensitivity Analysis Document Structure
```json
{
  "analysis_id": "cultural_{workflow_id}_{timestamp}",
  "prd_id": "prd_identifier",
  "workflow_id": "workflow_identifier",
  "overall_cultural_sensitivity": "low|moderate|high|critical",
  "overall_average_score": 0.75,
  "regional_scores": {
    "North America": 0.8,
    "Europe": 0.7,
    "Asia Pacific": 0.6
  },
  "key_cultural_issues": ["Issue 1", "Issue 2"],
  "recommendations": ["Recommendation 1", "Recommendation 2"],
  "total_features_analyzed": 5,
  "regions_analyzed": 3,
  "requires_human_review": true,
  "stored_at": "2024-01-01T12:00:00",
  "status": "active"
}
```

### 5. Key Methods in ExecutiveReportManager

#### Storage Methods
- `store_cultural_sensitivity_analysis()` - Store individual cultural analysis
- `store_workflow_results()` - Store both executive report and cultural analysis

#### Retrieval Methods
- `get_cultural_sensitivity_analysis()` - Get by analysis ID
- `get_cultural_sensitivity_analyses_by_prd()` - Get all for a PRD
- `get_cultural_sensitivity_analyses_by_workflow()` - Get all for a workflow
- `get_all_cultural_sensitivity_analyses()` - Get all active analyses

#### Management Methods
- `update_cultural_sensitivity_analysis()` - Update existing analysis
- `delete_cultural_sensitivity_analysis()` - Soft delete analysis
- `search_cultural_sensitivity_analyses()` - Search by text content

## Workflow Integration Flow

1. **Cultural Sensitivity Analysis Generation**: The workflow generates cultural sensitivity analysis for each feature and aggregates overall results
2. **Executive Report Generation**: The workflow generates comprehensive executive reports
3. **Unified Storage**: Both results are stored using `store_workflow_results()`
4. **Data Persistence**: Both executive reports and cultural sensitivity analysis are persisted in MongoDB
5. **API Response**: Both are included in the API response from the LangGraph API

## Testing

**File**: `langgraph/test_workflow_storage.py`
- **Manager Functionality Test**: Tests direct `ExecutiveReportManager` operations
- **Workflow Integration Test**: Tests end-to-end workflow storage
- **Data Integrity Verification**: Ensures both types of data are stored and retrievable
- **Search Functionality Test**: Verifies search capabilities work for both data types

## Benefits

1. **Unified Storage**: Single method call stores both executive reports and cultural sensitivity analysis
2. **Data Consistency**: Both data types are stored with proper relationships (PRD ID, Workflow ID)
3. **Complete CRUD Operations**: Full set of operations for managing cultural sensitivity analysis
4. **Search Capabilities**: Text-based search for cultural sensitivity analysis
5. **Soft Delete**: Safe deletion with status tracking
6. **Audit Trail**: Timestamps and status tracking for all operations

## Usage Example

```python
# In the workflow
storage_success = self.executive_report_manager.store_workflow_results(
    state.executive_report,
    state.cultural_sensitivity_analysis,
    state.prd_id,
    state.workflow_id
)

# Retrieval
manager = ExecutiveReportManager()
cultural_analyses = manager.get_cultural_sensitivity_analyses_by_workflow(workflow_id)
executive_reports = manager.get_executive_reports_by_workflow(workflow_id)
```

## Status

âœ… **COMPLETED**: Cultural sensitivity analysis is now being stored in MongoDB alongside executive reports.

The implementation ensures that:
- Cultural sensitivity analysis is generated by the `CulturalSensitivityAnalyzer` agent
- Both executive reports and cultural sensitivity analysis are stored in MongoDB
- Data can be retrieved, updated, and searched
- The workflow uses a unified storage method for both data types
- All operations include proper error handling and logging
