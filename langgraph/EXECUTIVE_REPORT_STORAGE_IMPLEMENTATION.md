# Executive Report Storage Implementation

## Overview

This document describes the implementation of executive report storage in MongoDB for the PRD analysis workflow. The executive reports are now automatically stored in a dedicated MongoDB collection when they are generated and returned from the PRD analysis API.

## Problem Solved

Previously, executive reports were generated by the workflow but were not being stored in MongoDB when returned from the PRD analysis API. This meant that executive reports were only available in the workflow output files and not persisted in the database for later retrieval.

## Solution Implemented

### 1. Updated LangGraph API Response Model

**File**: `langgraph/main.py`

**Changes**:
- Added `executive_report: Optional[Dict[str, Any]] = None` field to `WorkflowResponse` model
- Updated response preparation to include `executive_report=final_state.executive_report`

**Before**:
```python
class WorkflowResponse(BaseModel):
    # ... other fields ...
    status: str = "completed"
    # Missing executive_report field
```

**After**:
```python
class WorkflowResponse(BaseModel):
    # ... other fields ...
    status: str = "completed"
    executive_report: Optional[Dict[str, Any]] = None  # Added field
```

### 2. Created Executive Report Manager

**File**: `langgraph/agents/executive_report_manager.py`

**Features**:
- MongoDB connection management for executive reports collection
- Store executive reports with metadata
- Retrieve reports by report ID, PRD ID, or workflow ID
- Search functionality across report content
- Update and soft delete capabilities
- Comprehensive error handling

**Key Methods**:
```python
class ExecutiveReportManager:
    def store_executive_report(self, executive_report: Dict[str, Any], prd_id: str, workflow_id: str) -> bool
    def get_executive_report(self, report_id: str) -> Optional[Dict[str, Any]]
    def get_executive_reports_by_prd(self, prd_id: str) -> List[Dict[str, Any]]
    def get_executive_reports_by_workflow(self, workflow_id: str) -> List[Dict[str, Any]]
    def search_executive_reports(self, query: str, limit: int = 20) -> List[Dict[str, Any]]
    def update_executive_report(self, report_id: str, updates: Dict[str, Any]) -> bool
    def delete_executive_report(self, report_id: str) -> bool
```

### 3. Updated MongoDB Configuration

**File**: `mongodb_config.py`

**Changes**:
- Added `EXECUTIVE_REPORTS_COLLECTION = "executive_reports"` constant

### 4. Integrated Executive Report Storage in Workflow

**File**: `langgraph/langgraph_workflow.py`

**Changes**:
- Added import for `ExecutiveReportManager`
- Initialized `ExecutiveReportManager` in `ComplianceWorkflow.__init__()`
- Added automatic storage after executive report generation

**Integration Code**:
```python
# Store executive report in MongoDB
print(f"💾 Storing executive report in MongoDB...")
storage_success = self.executive_report_manager.store_executive_report(
    state.executive_report,
    state.prd_id,
    state.workflow_id
)

if storage_success:
    print(f"✅ Executive report stored in MongoDB successfully")
else:
    print(f"⚠️ Failed to store executive report in MongoDB")
```

### 5. Updated Backend API

**File**: `backend/main.py`

**Changes**:
- Added `executive_reports_collection` to MongoDB collections
- Created `store_executive_report_in_mongodb()` function
- Updated both PRD creation endpoints to store executive reports in dedicated collection
- Added executive reports count to health check endpoints

**Storage Function**:
```python
def store_executive_report_in_mongodb(executive_report: Dict[str, Any], prd_id: str, workflow_id: str) -> bool:
    """Store executive report in dedicated MongoDB collection"""
    # Implementation details...
```

## Data Structure

### Executive Report Document in MongoDB

```json
{
  "_id": "ObjectId",
  "report_id": "exec_report_20250101_120000",
  "prd_id": "prd_123",
  "workflow_id": "workflow_456",
  "prd_name": "PRD Name",
  "generated_at": "2025-01-01T12:00:00",
  "executive_summary": "Executive summary text...",
  "key_findings": ["Finding 1", "Finding 2"],
  "risk_assessment": {
    "overall_risk": "high",
    "critical_issues": 3,
    "states_at_risk": 15
  },
  "compliance_overview": {
    "total_features": 5,
    "compliance_rate": 0.6,
    "regulations_covered": ["GDPR", "CCPA"]
  },
  "recommendations": ["Rec 1", "Rec 2"],
  "next_steps": ["Step 1", "Step 2"],
  "stored_at": "2025-01-01T12:00:00",
  "status": "active"
}
```

## Storage Flow

### 1. Workflow Execution
1. PRD analysis workflow runs
2. Executive report is generated by `ExecutiveReportGenerator`
3. `ExecutiveReportManager` automatically stores report in MongoDB
4. Report is included in workflow state

### 2. API Response
1. LangGraph API returns response with executive report
2. Backend API receives response
3. Executive report is stored in dedicated collection
4. Report is also stored in PRD document for backward compatibility

### 3. Retrieval
1. Reports can be retrieved by report ID, PRD ID, or workflow ID
2. Search functionality available across report content
3. Reports maintain soft delete capability

## Testing

### Test Script
**File**: `langgraph/test_executive_report_storage.py`

**Tests**:
- Executive Report Manager functionality
- MongoDB connection and storage
- Retrieval and search capabilities
- Update and delete operations
- Workflow integration
- Automatic storage during workflow execution

### Running Tests
```bash
cd langgraph
python test_executive_report_storage.py
```

## Benefits

1. **Persistence**: Executive reports are now stored in MongoDB and persist across sessions
2. **Retrieval**: Reports can be retrieved by multiple identifiers (report ID, PRD ID, workflow ID)
3. **Search**: Full-text search across executive report content
4. **Management**: Update and delete capabilities for report management
5. **Integration**: Seamless integration with existing workflow and API
6. **Backward Compatibility**: Existing PRD documents still contain executive reports

## Usage Examples

### Retrieve Executive Report by Report ID
```python
from agents.executive_report_manager import ExecutiveReportManager

manager = ExecutiveReportManager()
report = manager.get_executive_report("exec_report_20250101_120000")
```

### Get All Reports for a PRD
```python
reports = manager.get_executive_reports_by_prd("prd_123")
for report in reports:
    print(f"Report: {report['report_id']} - {report['prd_name']}")
```

### Search Executive Reports
```python
results = manager.search_executive_reports("compliance risk", limit=10)
for result in results:
    print(f"Found: {result['report_id']} - {result['executive_summary'][:100]}...")
```

## Future Enhancements

1. **Indexing**: Add MongoDB indexes for better search performance
2. **Versioning**: Implement version control for executive reports
3. **Export**: Add export functionality for reports (PDF, CSV)
4. **Analytics**: Add analytics on executive report generation and usage
5. **Notifications**: Add notifications when new executive reports are generated

## Conclusion

The executive report storage implementation provides a robust, scalable solution for persisting executive reports in MongoDB. The implementation maintains backward compatibility while adding new functionality for report management and retrieval. The automatic storage ensures that all generated executive reports are properly persisted and available for future reference.
